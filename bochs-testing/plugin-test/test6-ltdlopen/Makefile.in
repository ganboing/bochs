top_builddir = ..
top_srcdir = @srcdir@/..
srcdir = @srcdir@
VPATH = @srcdir@

CXX=@CXX@
CXXFLAGS=@CXXFLAGS@ @INCLTDL@
LDFLAGS=@LDFLAGS@ @LT_LDFLAGS@
LIBS=@LIBS@ @LIBLTDL@

LIBTOOL=@LIBTOOL@
RPATH=`pwd`/lib

# select whether to use libtool or win32-specific target
all: all_libtool
#all: all_win32

########### libtool makefile for all platforms except win32 ###########
all_libtool: uselib libmodule1.la libmodule2.la

uselib: main.lo
	$(LIBTOOL) $(CXX) -export-dynamic $(LDFLAGS) -o uselib main.lo $(LIBS)

libmodule1.la: module1.lo
	$(LIBTOOL) $(CXX) -module $(LDFLAGS) -o libmodule1.la module1.lo -rpath ${RPATH}
	mkdir -p lib bin
	$(LIBTOOL) cp libmodule1.la ${RPATH}

libmodule2.la: module2.lo
	$(LIBTOOL) $(CXX) -module $(LDFLAGS) -o libmodule2.la module2.lo -rpath ${RPATH}
	mkdir -p lib bin
	$(LIBTOOL) cp libmodule2.la ${RPATH}

%.lo: %.cc
	$(LIBTOOL) $(CXX) $(CXXFLAGS) -c $<

test:
	@echo "*** Running test in `pwd`"
	-./uselib
	@echo "*** Test done in `pwd`"

clean:
	-$(LIBTOOL) rm libmodule1.la module1.lo libmodule2.la module2.lo
	rm -rf *.o *.lo *.la uselib.exe bin lib uselib uselib.exe
	rm -rf .libs
